# ⚠️ CRITICAL ARCHITECTURE RULES

## Rule #1: NEVER USE DIRECT HTTP CALLS

**PROHIBITED:**
```typescript
// ❌ WRONG - DO NOT DO THIS
import { HttpClient } from '@angular/common/http';

export class AuthService {
  constructor(private http: HttpClient) {}
  
  login(email: string, password: string): Observable<AuthResponse> {
    return this.http.post('/api/v1/auth/login', { email, password });
  }
}
```

**REQUIRED:**
```typescript
// ✅ CORRECT - ALWAYS USE THIS PATTERN
import { IrsApiClient, LoginRequest, AuthResponse } from '../../generated/generated/irs-api.client';

export class AuthService extends BaseApiService {
  login(email: string, password: string): Observable<AuthResponse> {
    const request = new LoginRequest({ email, password });
    return this.apiClient.login(request).pipe(
      map(response => response.result),
      tap(response => { /* handle response */ })
    );
  }
}
```

## Rule #2: ALL API CALLS THROUGH GENERATED CLIENT

Every service that calls the API MUST:

1. **Inject `IrsApiClient`** (preferably via BaseApiService)
   ```typescript
   protected readonly apiClient = inject(IrsApiClient);
   ```

2. **Use generated request classes** (RegisterRequest, LoginRequest, etc.)
   ```typescript
   const request = new LoginRequest({ email, password });
   ```

3. **Handle SwaggerResponse wrapper**
   ```typescript
   return this.apiClient.login(request).pipe(
     map(response => response.result)  // Extract the actual data
   );
   ```

4. **Never call URL paths directly**
   - ❌ `this.http.post('/api/v1/auth/login', ...)`
   - ✅ `this.apiClient.login(request)`

## Rule #3: SERVICE INHERITANCE PATTERN

All services that use the API should extend `BaseApiService`:

```typescript
import { BaseApiService } from '../core/base-api.service';
import { IrsApiClient, LoginRequest, AuthResponse } from '../../generated/generated/irs-api.client';

export class AuthService extends BaseApiService {
  /**
   * Login with email and password
   * Uses autogenerated IrsApiClient - DO NOT modify to use HttpClient directly
   */
  login(email: string, password: string): Observable<AuthResponse> {
    const request = new LoginRequest({ email, password });
    
    return this.apiClient.login(request).pipe(
      map(response => response.result),
      tap(response => {
        // Store auth data
      })
    );
  }
}
```

## Why This Rule Exists

1. **Type Safety**: Generated client provides full TypeScript types
2. **API Contract**: Automatic validation against API schema
3. **Consistency**: Single source of truth for API calls
4. **Maintainability**: Changes to API schema auto-update client
5. **Error Handling**: Standardized response handling via SwaggerResponse

## Enforcement

- **ESLint Rule**: No direct HttpClient imports in services
- **Base Class**: Provides protected `apiClient` property
- **Architecture Docs**: This file
- **Code Review**: Check all service API calls

## Where to Find Generated Client

**Location**: `src/generated/generated/irs-api.client.ts`

**Auto-generated by**: NSwag from backend API schema

**Contains**:
- `IrsApiClient` class with all API methods
- Request classes: `RegisterRequest`, `LoginRequest`, etc.
- Response classes: `AuthResponse`, `ProblemDetails`, etc.
- `SwaggerResponse<T>` wrapper for all responses

## Key Methods Available

```typescript
// Register user
apiClient.register(request: RegisterRequest): Observable<SwaggerResponse<AuthResponse>>

// Login user
apiClient.login(request: LoginRequest): Observable<SwaggerResponse<AuthResponse>>
```

## Common Mistakes to Avoid

❌ **Mistake 1**: Importing HttpClient in services
```typescript
import { HttpClient } from '@angular/common/http';  // ❌ WRONG
```

❌ **Mistake 2**: Hardcoding API paths
```typescript
return this.http.post('/api/v1/auth/login', ...);  // ❌ WRONG
```

❌ **Mistake 3**: Accessing response directly without unwrapping
```typescript
return this.apiClient.login(request);  // ❌ Missing map(r => r.result)
```

❌ **Mistake 4**: Creating custom request objects
```typescript
const request = { email, password };  // ❌ Should use RegisterRequest class
```

✅ **Correct Pattern**: Always follow Rule #3 pattern above

## Questions?

If you need to call an API endpoint:
1. Check if it exists in `src/generated/generated/irs-api.client.ts`
2. If not, request backend team to regenerate the client
3. Use it exactly as documented in the generated client
4. Follow the BaseApiService inheritance pattern
5. Reference this file for the pattern

---

**Last Updated**: January 22, 2026
**Enforced by**: ESLint, BaseApiService, Code Review
**Related Files**: 
- `src/app/core/base-api.service.ts`
- `src/generated/generated/irs-api.client.ts`
- `SKILL.md`
