<div class="page">
  <div class="page-header">
    <div>
      <p class="eyebrow">Research Page</p>
      <h1>
        {{ page()?.security_ticker || 'Loading' }} · {{ page()?.security_name || '' }}
      </h1>
      <p class="muted">FIGI {{ page()?.security_figi }} · {{ page()?.security_type || 'Instrument' }}</p>
      <app-score-indicator 
          [fundamentalScore]="fundamentalScore()" 
          [convictionScore]="convictionScore()">
      </app-score-indicator>
    </div>
    <div class="row wrap">
      <button class="icon-btn run" title="Run all agents" aria-label="Run all agents" (click)="runAllAgents()">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
      </button>
      <a routerLink="/research" class="btn secondary">Back to workspace</a>
    </div>
  </div>

  <div *ngIf="isLoadingPage()" class="status">Loading research page…</div>
  <div *ngIf="pageError()" class="error">{{ pageError() }}</div>

  <ng-container *ngIf="!isLoadingPage() && page() as research">
    <section class="grid-2">
      <div class="surface metric-card">
        <div class="card-title">Fundamental score</div>
        <div class="score">{{ fundamentalScore() ?? '—' }}</div>
        <p class="meta-text">-3 – +3 net sentiment from sections.</p>
      </div>
      <div class="surface metric-card">
        <div class="card-title">Conviction score</div>
        <div class="score">{{ convictionScore() ?? '—' }}</div>
        <p class="meta-text">0 – 5 aggregated from sections.</p>
      </div>

    </section>

    <section class="surface card stack sections">
      <div class="space-between">
        <div>
          <div class="card-title">Sections</div>
          <div class="meta-text">Generated by the Structure Agent; comments stay team-private.</div>
        </div>
        <div class="row wrap">
          <span class="pill">{{ sections().length }} sections</span>
          <button class="btn secondary" (click)="addNewSection()">Add Section</button>
        </div>
      </div>

      <div class="section-grid-vertical">
        <article class="section-card surface" *ngFor="let section of sections(); trackBy: trackBySection">
          <header class="space-between">
            <div>
              <h3>{{ section.title }}</h3>              
            </div>
            <div class="row wrap">
              <div class="score-pills">
                <span class="pill">Fundamental: {{ section.fundamental_score ?? '—' }}</span>
                <span class="pill">Conviction: {{ section.conviction_score ?? '—' }}</span>
              </div>
              <button class="icon-btn delete" title="Delete section" aria-label="Delete section" (click)="deleteSection(section)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6l-2 14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                  <path d="M8 6l1-3h6l1 3"></path>
                </svg>
              </button>
            </div>
          </header>
<!-- 
          <div class="ai-content" *ngIf="section.ai_generated_content; else noContent">
            <pre>{{ section.ai_generated_content }}</pre>
          </div>
          <ng-template #noContent>
            <p class="muted">No AI content yet. Attach an agent to populate this section.</p>
          </ng-template> -->

          <div class="section-agents">
            <div class="space-between wrap">
              <div class="card-title">Section Agents</div>
              <div class="attach-row">
                <select class="input" [ngModel]="getSectionAttachState(section.id!).selectedAgentId" (ngModelChange)="setSectionAttachSelectedAgentId(section.id!, $event)">
                  <option [ngValue]="null">Select agent</option>
                  <option *ngFor="let agent of getUnattachedAgentsForSection(section.id!); trackBy: trackByAvailableAgent" [ngValue]="agent.id">
                    {{ agent.name }} • {{ agent.visibility }} • {{ agent.endpoint_url }}
                  </option>
                </select>
                <button class="btn" (click)="attachSectionAgent(section.id!)" [disabled]="getSectionAttachState(section.id!).isAttaching">
                  {{ getSectionAttachState(section.id!).isAttaching ? 'Attaching…' : 'Attach' }}
                </button>
              </div>
            </div>
            <div class="error" *ngIf="getSectionAttachState(section.id!).error">{{ getSectionAttachState(section.id!).error }}</div>

            <div class="agent-grid" *ngIf="getSectionAgentsFor(section.id!).length > 0">
              <article class="agent-card surface" *ngFor="let agent of getSectionAgentsFor(section.id!); trackBy: trackByAgent">
                <div class="space-between">
                  <div>
                    <div class="card-title">{{ agent.name }}</div>
                    <div class="meta-text">Last run: {{ agent.last_run_at ? (agent.last_run_at | date:'short') : 'Never' }}</div>
                  </div>
                  <div style="display:flex; gap:8px;">
                    <button class="icon-btn run" title="Run now" aria-label="Run section agent" (click)="runSectionAgentNow(agent); $event.stopPropagation()" [disabled]="agent.last_run_status === 'Running'">
                      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
                    </button>

                    <button class="btn secondary" (click)="toggleSectionAgent(agent)">
                      {{ agent.is_enabled ? 'Disable' : 'Enable' }}
                    </button>

                    <button class="icon-btn delete" title="Delete agent" aria-label="Delete section agent" (click)="deleteSectionAgent(agent); $event.stopPropagation()">
                      <!-- clearer trash icon (trash-2) -->
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6l-2 14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                        <path d="M8 6l1-3h6l1 3"></path>
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="pill status-pill" [class.offline]="!agent.is_enabled">{{ agent.last_run_status || 'Idle' }}</div>

                <div class="runs">
                  <div class="card-title">Runs</div>
                  <div class="status" *ngIf="isSectionAgentRunLoading(agent.id!)">Loading runs…</div>
                  <div class="run-list" *ngIf="getSectionAgentRun(agent.id!) as run">
                    <div class="run" *ngIf="run">
                      <div class="run-status">{{ run.status }}</div>
                      <div class="meta-text">{{ run.started_at | date:'short' }}</div>
                      <div *ngIf="run.output" class="meta-text" [innerHTML]="toHtml(run.output)"></div>
                      <p *ngIf="run.error" class="error">{{ run.error }}</p>
                    </div>
                  </div>
                </div>
              </article>
            </div>
          </div>

          <div class="section-summary" *ngIf="section.section_summary">
            <div class="card-title">Summary</div>
            <p>{{ section.section_summary }}</p>
          </div>

          <div class="comments">
            <div class="space-between">
              <div class="card-title">Comments</div>
              <div class="pill" *ngIf="commentsBySection()[section.id!]">
                {{ commentsBySection()[section.id!]?.length || 0 }} entries
              </div>
            </div>

            <div class="comment-list" *ngIf="commentsBySection()[section.id!] as comments">
              <div class="comment" *ngFor="let c of comments; trackBy: trackByComment" [class.expanded]="isCommentExpanded(c.id!)">
                <div class="comment-meta">{{ c.author_agent_name || 'Analyst' }} • {{ c.created_at | date:'short' }}</div>
                <p class="comment-content" [class.truncated]="!isCommentExpanded(c.id!) && (c.content?.length ?? 0) > 150">{{ c.content }}</p>
                <button *ngIf="(c.content?.length ?? 0) > 150" class="btn-show-more" (click)="toggleCommentExpand(c.id!)">
                  {{ isCommentExpanded(c.id!) ? 'Show less' : 'Show more' }}
                </button>
              </div>
            </div>

            <div class="status" *ngIf="commentsLoading()[section.id!]">Saving…</div>

            <div class="comment-form">
              <textarea
                class="input"
                rows="2"
                placeholder="Share context or paste logs"
                [ngModel]="drafts()[section.id!]"
                (ngModelChange)="updateDraft(section.id!, $event)"></textarea>
              <button class="btn secondary" (click)="submitComment(section.id!)" [disabled]="commentsLoading()[section.id!]">
                Post
              </button>
            </div>
          </div>
        </article>
      </div>
    </section>

    <section class="surface card stack sections">
      <div class="space-between wrap">
        <div>
          <div class="card-title">Agents</div>
          <div class="meta-text">Attach REST API agents (Private or Team) to enrich sections.</div>
        </div>
        <div class="attach-row">
          <select class="input" [(ngModel)]="attachState().selectedAgentId">
            <option [ngValue]="null">Select agent</option>
            <option *ngFor="let agent of unattachedAgents(); trackBy: trackByAvailableAgent" [ngValue]="agent.id">
              {{ agent.name }} • {{ agent.visibility }} • {{ agent.endpoint_url }}
            </option>
          </select>
          <button class="btn" (click)="attachAgent()" [disabled]="attachState().isAttaching">
            {{ attachState().isAttaching ? 'Attaching…' : 'Attach' }}
          </button>
        </div>
      </div>
      <div class="error" *ngIf="attachState().error">{{ attachState().error }}</div>
      <div class="status" *ngIf="agentsLoading()">Loading agents…</div>

      <div class="agent-grid">
        <article class="agent-card surface" *ngFor="let agent of pageAgents(); trackBy: trackByAgent">
          <div class="space-between">
            <div>
              <div class="card-title">{{ agent.name }}</div>
              <div class="meta-text">Last run: {{ agent.last_run_at ? (agent.last_run_at | date:'short') : 'Never' }}</div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="icon-btn run" title="Run now" aria-label="Run agent" (click)="runAgentNow(agent); $event.stopPropagation()" [disabled]="agent.last_run_status === 'Running'">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              </button>

              <button class="btn secondary" (click)="toggleAgent(agent)">
                {{ agent.is_enabled ? 'Disable' : 'Enable' }}
              </button>

              <button class="icon-btn delete" title="Delete agent" aria-label="Delete page agent" (click)="deletePageAgent(agent); $event.stopPropagation()">
                <!-- clearer trash icon (trash-2) -->
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6l-2 14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                  <path d="M8 6l1-3h6l1 3"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="pill status-pill" [class.offline]="!agent.is_enabled">{{ agent.last_run_status || 'Idle' }}</div>

          <div class="runs">
            <div class="card-title">Runs</div>
            <div class="status" *ngIf="agentRunsLoading()[agent.id!]">Loading runs…</div>
            <div class="run-list" *ngIf="agentRuns()[agent.id!] as run">
              <div class="run" *ngIf="run">
                <div class="run-status">{{ run.status }}</div>
                <div class="meta-text">{{ run.started_at | date:'short' }}</div>
                <div *ngIf="run.output" class="meta-text" [innerHTML]="toHtml(run.output)"></div>
                <p *ngIf="run.error" class="error">{{ run.error }}</p>
              </div>
            </div>
          </div>
        </article>
      </div>

      <div class="empty-state" *ngIf="!agentsLoading() && pageAgents().length === 0">
        No agents attached yet. Attach a Private or Team agent to populate section content.
      </div>
    </section>
  </ng-container>

  <app-confirm-modal *ngIf="confirmState()"
    [title]="confirmState()?.kind === 'page-agent' ? 'Delete agent' : confirmState()?.kind === 'section-agent' ? 'Delete section agent' : 'Delete section'"
    [message]="confirmState()?.kind === 'page-agent'
      ? ('Delete agent association ' + (confirmState()?.agent?.name || '') + ' and all past runs? This cannot be undone.')
      : confirmState()?.kind === 'section-agent'
      ? ('Delete section agent ' + (confirmState()?.agent?.name || '') + ' and all past runs? This cannot be undone.')
      : ('Delete section ' + (confirmState()?.section?.title || '') + ' and all associated comments and agents? This cannot be undone.')"
    (confirm)="onConfirmDelete()"
    (cancel)="cancelConfirm()"></app-confirm-modal>

</div>
